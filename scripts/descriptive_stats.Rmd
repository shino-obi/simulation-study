---
title: "Untitled"
author: "Lukas Higi"
date: "15 10 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "P:/PhD/02 Simulationsstudie/simulation-study/")

```

```{r echo = FALSE}
# Dataset call

library(tidyverse)

load("data/data_covar.rda")
load("data/data_main.rda")

```

```{r}
# Participant characteristics
table_covar <- data_covar %>% select(p_id,
                                     clinic, 
                                     prof, 
                                     exp, 
                                     pededose, 
                                     calc
)

# Create a table long format of covariates to calculate frequency of categorical variables
## switch factor coding to character as pivot longer seems to have a problem with it
table_covar[] <- lapply(table_covar, as.character)

## long format
table_factor <- pivot_longer(data = table_covar, 
                             cols = c(clinic, 
                                      prof, 
                                      exp, 
                                      pededose, 
                                      calc), 
                             names_to = "variable", 
                             values_to = "values")  

## calc frequency of categorical variables
table_1_factor <- table_factor %>% group_by(variable, values) %>% tally()

### IQR of age
table_1_age <- data.frame(mean = mean(data_covar$age),
                          median = median(data_covar$age),
                          q25 = quantile(data_covar$age, probs = 0.25),
                          q75 = quantile(data_covar$age, probs = 0.75)
)

```

```{r}
# ERRORS - Total

### Sum of all errors (total)
overall.total <- data_main %>% 
                  dplyr::filter(is_error == 1) %>%
                  count()


#### add percentage
overall.total$total_possible <- nrow(data_main)

overall.total$percent <- round(x = overall.total$n / overall.total$total_possible * 100, 
                               digits = 1)


### Sum of all errors (confirmatory)

overall.confirmatory <- data_main %>%
                          dplyr::filter(block_type != 2) %>%
                          dplyr::filter(is_error == 1) %>%
                          count()


#### add percentage
overall.confirmatory$total_possible <- nrow(data_main %>% 
                                              dplyr::filter(block_type != 2)
)

overall.confirmatory$percent <- round(x = overall.confirmatory$n / overall.confirmatory$total_possible * 100, 
                               digits = 1)


### PEDeDose (full)
overall.full <- data_main %>%
                  dplyr::filter(block_type == 3) %>%
                  dplyr::filter(is_error == 1) %>%
                  count()


#### add percentage
overall.full$total_possible <- nrow(data_main %>%
                                              dplyr::filter(block_type == 3)
)

overall.full$percent <- round(x = overall.full$n / overall.full$total_possible * 100, 
                               digits = 1)


### PEDeDose (base)
overall.base <- data_main %>%
                  dplyr::filter(block_type == 2) %>%
                  dplyr::filter(is_error == 1) %>%
                  count()


#### add percentage
overall.base$total_possible <- nrow(data_main %>%
                                                dplyr::filter(block_type == 2)
)

overall.base$percent <- round(x = overall.base$n / overall.base$total_possible * 100, 
                               digits = 1)


### Conventional dosing information
overall.control <- data_main %>%
                    dplyr::filter(block_type == 1) %>%
                    dplyr::filter(is_error == 1) %>%
                    count()


#### add percentage
overall.control$total_possible <- nrow(data_main %>%
                                              dplyr::filter(block_type == 1)
)

overall.control$percent <- round(x = overall.control$n / overall.control$total_possible * 100, 
                               digits = 1)


## Combine all
overall.errors <- rbind(overall.total, overall.confirmatory, overall.full, overall.base, overall.control)
overall.errors$name <- c("total", "confirmatory", "full", "base", "control")

```

```{r}
# ERRORS - by error subtype
## Transcription errors

### Sum of all errors (total)


### Sum of all errors (confirmatory)


### PEDeDose (full)


### PEDeDose (base)


### Conventional dosing information


## 10-fold errors
### Sum of all errors (total)

### Sum of all errors (confirmatory)

### PEDeDose (full)

### PEDeDose (base)

### Conventional dosing information


```

```{r}
# ERRORS - by difficulty types

## Body surface caclulation
### Sum of all errors (total)

### Sum of all errors (confirmatory)

### PEDeDose (full)

### PEDeDose (base)

### Conventional dosing information


## Maximal dosage
### Sum of all errors (total)

### Sum of all errors (confirmatory)

### PEDeDose (full)

### PEDeDose (base)

### Conventional dosing information


## Preterm infants
### Sum of all errors (total)

### Sum of all errors (confirmatory)

### PEDeDose (full)

### PEDeDose (base)

### Conventional dosing information

```

```{r}
# ERRORS - by exercises
### Sum of all errors (total)
exercise_id_list <- data.frame(ex_id = seq(from = 1, to = 18, by = 1))

exercise.total <- left_join(exercise_id_list, 
                            data_main %>%
                              group_by(ex_id) %>%
                              filter(is_error == 1) %>%
                              count() %>% 
                              ungroup(),
                            by = "ex_id"
)

exercise.total <- cbind(exercise.total,
                         data_main %>% 
                           count(ex_id, name = "total_possible") %>%
                           ungroup() %>%
                           select(total_possible)
)

#### switch NA's to 0
summary(is.na(exercise.total$n))

exercise.total$n[is.na(exercise.total$n)] <- 0


#### add percentage
exercise.total$percent <-  round(x = exercise.total$n / exercise.total$total_possible * 100, 
                                 digits = 1)


# FOR SUBGROUPS: create df with all exercise and block combinations and join with data_main

ex_block_df <- data.frame(ex_id = rep(x = seq(from = 1, to = 18, by = 1), times = 3))
ex_block_df$ex_id <- sort(ex_block_df$ex_id)
ex_block_df$block_type <- rep(x = seq(from = 1, to = 3, by = 1), times = 3)

ex_block_df$id_exercise_block <- NA

for (i in 1:nrow(ex_block_df)) {
  ex_block_df$id_exercise_block[i] <- paste(ex_block_df$ex_id[i], ex_block_df$block_type[i], sep = "_")
}


exercise.joined <- left_join(ex_block_df,
                  data_main[c("id_exercise_block", "is_error")],
                  by = c("id_exercise_block")
)

exercise.distinct <- exercise.joined %>%
                      group_by(id_exercise_block) %>%
                      filter(is_error == 1) %>%
                      count() %>% 
                      ungroup()

#### get all exercise ids back again
exercise.distinct <- left_join(ex_block_df,
                               exercise.distinct,
                               by = c("id_exercise_block")
)



exercise.distinct <- cbind(exercise.distinct,
                         data_main %>% 
                           count(id_exercise_block, name = "total_possible") %>%
                           ungroup() %>%
                           select(total_possible)
)
####### now group by combinations for different sugroups


### Sum of all errors (confirmatory)



### PEDeDose (full)


### PEDeDose (base)


### Conventional dosing information



#### create new ex_id column to be sure all questions are represented



```

```{r}
# Time
### Mean time overall (total)
time.participant <- data_main %>%
                      group_by(p_id) %>%
                      summarise(mean = round(mean(time), digits = 1),
                                sd = round(sd(time),digits = 1),
                                median = round(median(time), digits = 1),
                                q25 = round(quantile(time, probs = 0.25), digits = 1),
                                q75 = round(quantile(time, probs = 0.75), digits = 1)
                                )
  
### Mean (+ median & IQR) time per exercise
time.exercise <- data_main %>%
                      group_by(ex_id) %>%
                      summarise(mean = round(mean(time), digits = 1),
                                sd = round(sd(time),digits = 1),
                                median = round(median(time), digits = 1),
                                q25 = round(quantile(time, probs = 0.25), digits = 1),
                                q75 = round(quantile(time, probs = 0.75), digits = 1)
                                )

## Mean (+ median & IQR) time per block
time.block <- data_main %>%
                      group_by(block_type) %>%
                      summarise(mean = round(mean(time), digits = 1),
                                sd = round(sd(time),digits = 1),
                                median = round(median(time), digits = 1),
                                q25 = round(quantile(time, probs = 0.25), digits = 1),
                                q75 = round(quantile(time, probs = 0.75), digits = 1)
                                )

### Mean (+ median & IQR) time per exercise-condition combination
time.distinct <- data_main %>%
                      group_by(id_exercise_block) %>%
                      summarise(mean = round(mean(time), digits = 1),
                                sd = round(sd(time),digits = 1),
                                median = round(median(time), digits = 1),
                                q25 = round(quantile(time, probs = 0.25), digits = 1),
                                q75 = round(quantile(time, probs = 0.75), digits = 1)
                                )
```
